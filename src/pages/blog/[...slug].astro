---
import "../../styles/content.css";

import { getCollection, render } from "astro:content";
import type { CollectionEntry } from "astro:content";

import PageWrapper from "@src/components/layouts/wrapper.astro";
import PageHeader from "@src/components/layouts/header.astro";
import BackToPrev from "@src/features/blog/components/back-to-prev.astro";
import ShareBar from "@src/features/blog/components/share-bar.astro";
import GreatImage from "@src/components/great-image/index.astro";

import { readingTime } from "@src/features/blog/utility";

export async function getStaticPaths() {
  const posts = await getCollection("posts");

  return posts.map(post => ({
    params: { slug: post.id },
    props: post,
  }));
}

type Props = CollectionEntry<"posts">;

const post = Astro.props;

const date = new Date(post.data.date);
const readingTimeInMinutes = readingTime(post.body || "");

const { Content } = await render(post);

const openGraphImage = `images/posts/${post.id}/cover.jpg`;

const coverURL = post.data.cover;

const defaultCoverSize = {
  height: 285,
  width: 800,
};
---

<PageWrapper
  title={post.data.title}
  description={post.data.summary}
  opengraphImage={openGraphImage}
>
  <header>
    <div class="mb-8">
      <BackToPrev href="/blog"> all posts</BackToPrev>
    </div>

    <GreatImage
      src={coverURL}
      alt={post.data.title}
      width={defaultCoverSize.width}
      height={defaultCoverSize.height}
      useRemoteBlur={false}
      customClass={{
        common:
          "aspect-video w-full rounded-md object-cover sm:aspect-[16/5.68]",
      }}
    />

    <div class="my-8 flex flex-col-reverse gap-8 sm:mt-8 sm:mb-10 sm:flex-row">
      <div class="flex-1">
        <PageHeader
          title={post.data.title}
          description={post.data.summary}
          descriptionClass="max-w-none text-wrap"
        />
        {
          post.data.aiUsage && (
            <p class="text-secondary mt-4 text-sm leading-relaxed lg:text-base">
              <span class="text-primary font-medium">AI usage:</span>
              {` ${post.data.aiUsage}`}
            </p>
          )
        }
      </div>
      <section class="flex flex-row gap-8 sm:flex-col">
        {
          date && (
            <p class="flex flex-col">
              <span class="text-secondary mb-1 block text-sm">
                published on
              </span>
              <time
                class="text-primary text-base leading-tight"
                datetime="2023-06-22T00:00:00.000Z"
              >
                {new Date(date).toLocaleDateString("pt-BR")}
              </time>
            </p>
          )
        }
        {
          date && (
            <p class="flex flex-col">
              <span class="text-secondary mb-1 block text-sm">
                reading time
              </span>
              <span class="text-primary text-base leading-tight">
                {readingTimeInMinutes} minutes
              </span>
            </p>
          )
        }
      </section>
    </div>
    <div class="mb-8">
      <ShareBar URLText={post.data.title} />
    </div>
  </header>
  <div id="content-wrapper" class="content">
    <Content />
  </div>
  <footer class="text-secondary mt-8 rounded-md leading-relaxed text-balance">
    <h5 class="mb-4 text-xl font-semibold text-white lg:text-3xl">
      You made it!
    </h5>
    <p class="text-sm lg:text-base">
      Thanks for reading all the way through. I appreciate it! ðŸŽ‰
    </p>
  </footer>
</PageWrapper>
<script>
  const enhanceCodeBlocks = (root: ParentNode = document) => {
    const inlineCodeOnlyParagraphs =
      root.querySelectorAll<HTMLParagraphElement>("p > code:only-child");

    inlineCodeOnlyParagraphs.forEach(code => {
      const text = code.textContent?.trim() ?? "";
      const shouldPromoteToBlock = text.includes("\n") || text.length > 80;

      if (!shouldPromoteToBlock) {
        return;
      }

      const paragraph = code.parentElement;

      if (!paragraph) {
        return;
      }

      const pre = document.createElement("pre");
      const nextCode = code.cloneNode(true);

      pre.classList.add("astro-code");
      pre.appendChild(nextCode);
      paragraph.replaceWith(pre);
    });

    const codeBlocks = root.querySelectorAll<HTMLElement>("pre > code");

    codeBlocks.forEach(code => {
      const pre = code.parentElement;

      if (!(pre instanceof HTMLPreElement)) {
        return;
      }

      pre.classList.add("astro-code");

      const languageClass = Array.from(code.classList).find(cssClass =>
        cssClass.startsWith("language-"),
      );

      if (languageClass && !pre.dataset.language) {
        pre.dataset.language = languageClass.replace("language-", "");
      }

      const hasLineElements = code.querySelector(":scope > .line");
      const hasChildMarkup = code.children.length > 0;

      if (hasLineElements || hasChildMarkup) {
        return;
      }

      const rawContent = code.textContent ?? "";
      const normalizedContent = rawContent.replace(/\n$/, "");
      const lines =
        normalizedContent.length > 0 ? normalizedContent.split("\n") : [""];

      code.textContent = "";

      lines.forEach(lineText => {
        const line = document.createElement("span");
        line.className = "line";
        line.textContent = lineText.length > 0 ? lineText : " ";
        code.append(line);
      });
    });
  };

  enhanceCodeBlocks(document.getElementById("content-wrapper") ?? document);
</script>
